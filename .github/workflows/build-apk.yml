name: Build AI Agent APK with Models

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  BERT_URL: "https://huggingface.co/prajjwal1/bert-tiny/resolve/main/model.tflite"
  DQN_URL: "https://huggingface.co/prajjwal1/bert-tiny/resolve/main/model.tflite" # Mock DQN URL for demo

jobs:
  build-debug:
    name: Build Debug APK with Models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Retry Checkout on Failure
        if: failure()
        run: |
          echo "Checkout failed, retrying in 10s..."
          sleep 10
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git fetch --depth 1 origin ${{ github.sha }}
          git checkout FETCH_HEAD

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Create Models Directory
        run: mkdir -p app/src/main/assets/models

      - name: Download Models
        run: |
          echo "ðŸ“¥ Downloading models..."
          curl -L "$BERT_URL" -o app/src/main/assets/models/bert_tiny_int8.tflite
          curl -L "$DQN_URL" -o app/src/main/assets/models/dqn_fp16.tflite

          # Create dummy hash files if secrets not present
          echo "dummy" > app/src/main/assets/models/bert_tiny_int8.tflite.sha256
          echo "dummy" > app/src/main/assets/models/dqn_fp16.tflite.sha256

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-with-models
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 14

  build-release:
    name: Build Optimized Release APK
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Retry Checkout on Failure
        if: failure()
        run: |
          echo "Checkout failed, retrying in 10s..."
          sleep 10
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git fetch --depth 1 origin ${{ github.sha }}
          git checkout FETCH_HEAD

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Create Models Directory
        run: mkdir -p app/src/main/assets/models

      - name: Download Models
        run: |
          curl -L "$BERT_URL" -o app/src/main/assets/models/bert_tiny_int8.tflite
          curl -L "$DQN_URL" -o app/src/main/assets/models/dqn_fp16.tflite

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Decode Keystore
        if: env.KEYSTORE_BASE64 != ''
        run: |
          echo "Checking KEYSTORE_BASE64 secret..."
          if [[ ${#KEYSTORE_BASE64} -lt 20 ]]; then
            echo "Error: KEYSTORE_BASE64 is too short or empty. Skipping release signing."
            exit 0
          fi
          printf "%s" "$KEYSTORE_BASE64" | base64 -d --ignore-garbage > app/release.keystore
          if [ ! -s "app/release.keystore" ]; then
            echo "Error: Failed to decode keystore. Skipping release signing."
            rm -f app/release.keystore
          fi

      - name: Build Optimized Release APK
        run: |
          if [ -f "app/release.keystore" ]; then
            ./gradlew assembleRelease --stacktrace
          else
            echo "No keystore found, skipping release build. Check if KEYSTORE_BASE64 secret is set."
            exit 0
          fi

      - name: Upload Release APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-with-models
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
